---
title: "Project Osbourne:"
subtitle: "An overview with git"
output: 
  revealjs::revealjs_presentation:
    theme: simple # “simple”, “sky”, “beige”, “serif”, “solarized”, “blood”, “moon”, “night”, “black”, “league” or “white”).
    fig_width: 9
    fig_height: 6
    highlight: haddock # “tango”, “pygments”, “kate”, “monochrome”, “espresso”, “zenburn”, and “haddock”.
---

# Project Osbourne

```{r setup, include = F}
knitr::opts_chunk$set(fig.align = 'center',
                      message = FALSE,
                      warning = FALSE)

# Load the required libraries
library(tidyverse)
library(lubridate)
library(ggkpmg)
library(tidytext)
```

## Project Osbourne

* Regulatory calculation/remediation

<br>

* Major UK retailer

<br>

* Vague delivery objectives

## Project Osbourne

* Very messy data

<br>

* Dynamic requirements

<br>

* Tight deadlines

## Project Osbourne

* Clear audit trails

<br>

* Code and work-product collaboration

<br>

* Strict version control

# git

## git

<blockquote><p align="left">"If you're having `git` problems I feel bad for you, son. I got 99 problems but `git` ain't one."</p>
<footer><cite><a href="mailto:jim.leach@kpmg.co.uk?subject=having%20git%20problems">Anonymous</a></cite>
</footer>
</blockquote>

## git

* Free, open-source software for distributed version control

<br>

* Enables collaboration across a large code base

<br>

* Automatically creates an audit trail of changes - the git commit log

## git

The git log:

```{r ggkpmg-log, message = FALSE, warning = FALSE, echo = FALSE}
ggkpmg <- readr::read_tsv("./ggkpmg/ggkpmg-log.tsv", col_names = FALSE) %>% 
  set_names(c("commit_id", "author", "datetime", "message")) %>% 
  mutate(datetime = gsub("\\ \\+[0-9]+", "", datetime))

knitr::kable(head(ggkpmg, 3))
```

A history of _every_ change made to the code.

## git

Getting the log is easy:

```sh
git log
```

Parsing it in to a tab-separated structure:

```sh
git log --date=iso --pretty=format:"%h%x09%an%x09%ad%x09%s"
```

And saving it to a file

```sh
git log --date=iso --pretty=format:"%h%x09%an%x09%ad%x09%s" > log.tsv
```

# Exploring the timeline

```{r get-logs, message = FALSE, warning = FALSE, echo = FALSE}
# List out all files to be read in
files_dir <- list.files("./logs", pattern = ".tsv", full.names = T)
files <- gsub(".tsv", "", list.files("./logs", pattern = ".tsv"))

# Define function to read commit tsv (weird formatting prevents read_tsv)
read_commits <- function(commits_data, data_name) {
  readr::read_lines(commits_data) %>% 
    map(stringr::str_split, '\t') %>% 
    map(`[[`, 1) %>% 
    map(t) %>% 
    map(as_tibble) %>% 
    bind_rows() %>% 
    set_names(c("commit", "author", "datetime", "comment")) %>% 
    mutate(version = data_name)
}  

# Read in data
commits <- map2(files_dir, files, read_commits) %>% # Read in
  bind_rows()  # Collapse in to single table

commits_cln <- commits %>% 
  extract(version, "version_number", regex = "([[0-9]]+)", remove = F) %>% 
  mutate(datetime = gsub("\\ \\+0000", "", datetime),
         datetime = ymd_hms(datetime),
         date = date(datetime),
         hour = hour(ceiling_date(datetime, unit = "hours")),
         day = wday(date, label = T, abbr = F),
         version_number = as.numeric(version_number),
         author = if_else(author == "Sara young", "Sara Young", author),
         author = if_else(author == "unknown", "Unknown", author)) %>%
  group_by(commit) %>% 
  mutate(earliest_version = min(version_number)) %>% 
  ungroup() %>% 
  filter(version_number == earliest_version) %>% 
  distinct() %>% 
  arrange(datetime) %>% 
  separate(version, c("label", "ver"), "_") %>% 
  select(-label) %>% 
  mutate(ver = forcats::fct_reorder(ver, datetime, min))
```

## Commits vs time

```{r commits_vs_day, echo = FALSE}
commits_cln %>% 
  group_by(date) %>% 
  summarise(commits = n()) %>% 
  ggplot(aes(date, commits)) +
  geom_line(colour = kpmgcolours("primary")[1], size = 1.25) +
  labs(x = "Date", 
       y = "Commits",
       title = "Total commits per date",
       subtitle = "A single commit can represent dozens of changes across multiple code files") +
  theme_kpmg()
```

## Cumulative commits

```{r commits_cumulative, echo = FALSE}
commits_cln %>% 
  group_by(date) %>% 
  summarise(commits = n()) %>% 
  mutate(total = cumsum(commits)) %>% 
  ggplot(aes(date, total)) +
  geom_step(colour = kpmgcolours("primary")[1], size = 1.25) +
  labs(x = "Date", 
       y = "Commits",
       title = "Cumulative commits over time",
       subtitle = "We had two very busy weeks: one in late Jan and one in late Feb.") +
  theme_kpmg()
```

## Versions over time

```{r commit_versions_vs_date, echo = FALSE}
commits_cln %>% 
  group_by(version_number, date) %>% 
  summarise(commits = n()) %>% 
  ggplot(aes(date, commits)) +
  geom_line(aes(colour = as.factor(version_number)), size = 1.25) +
  #scale_colour_manual(values = unname(kpmgcolours("graphs")[1:9])) +
  labs(x = "Date", 
       y = "Commits",
       title = "Total commits per date, per build version",
       subtitle = "Some versions overlapped as we switched back and forth\nbetween different calculation logics") +
  guides(colour = guide_legend("Build version", nrow = 2, byrow = T)) +
  theme_kpmg() +
  theme(legend.position = "bottom")
```

## Working day

```{r commit_days, echo = FALSE}
ggplot(commits_cln, aes(day)) +
  geom_bar(stat = "count", fill = kpmgcolours("primary")[1]) +
  labs(x = "Day", 
       y = "Total commits",
       title = "Total commits per day of week") +
  theme_kpmg()
```

## Working day, and night

```{r commit_hours, echo = FALSE}
ggplot(commits_cln, aes(hour)) +
  geom_bar(stat = "count", fill = kpmgcolours("primary")[1]) +
  scale_x_continuous(breaks = seq(0, 24, 2)) +
  labs(x = "Hour", 
       y = "Total commits",
       title = "Total commits per hour of the day") +
  theme_kpmg()
```

***

<blockquote><p align="left">"whay am I gitting at this hour of the night ???????"</p>
<footer><cite><p>Anonymous</p></cite>
</footer>
</blockquote>

# Looking at authors

## Total commits per author

```{r commits_per_author, echo = FALSE}
commits_cln %>% 
  mutate(author = forcats::fct_infreq(author),
         author = forcats::fct_rev(author)) %>% 
  #filter(author != "Jim Leach") %>% 
  ggplot(aes(author)) +
  geom_bar(fill = kpmgcolours("graphs")[1]) +
  labs(x = "Author",
       y = "Total commits",
       caption = "Commits are not 100% representative of lines of code written.\nOne commit may contain many changes and some team members commit more frequently than others.") + 
  coord_flip() +
  theme_kpmg() +
  theme(plot.caption = element_text(size = 8, colour = "grey"))
```


## Commits per author over time

```{r commits_per_author_vs_time, echo = FALSE}
commits_cln %>% 
  group_by(date, author) %>% 
  summarise(day_commits = n()) %>% 
  ungroup() %>% 
  arrange(author, date) %>% 
  group_by(author) %>% 
  mutate(total_commits = cumsum(day_commits)) %>% 
  ungroup() %>% 
  ggplot(aes(date, total_commits)) +
  geom_step(aes(colour = author), size = 2) +
  scale_colour_manual(values = unname(kpmgcolours("graphs")[1:7])) +
  labs(x = "Date",
       y = "Total commits",
       title = "Cumulative commits over time",
       subtitle = "Some team members made almost 50 commits in a single day!",
       caption = "Commits are not 100% representative of lines of code written.\nOne commit may contain many changes and some team members commit more frequently than others.") + 
  guides(colour = guide_legend("Author")) + 
  theme_kpmg() +
  theme(legend.position = "bottom",
        plot.caption = element_text(size = 8, colour = "grey"))
```

# Commit message content

```{r get_messages, echo = FALSE}
# Pull in auto stop words
data("stop_words")

# Create extra stop words
stops_manual <- tibble(word = c("osbourne",
                                "build_008",
                                "projects",
                                "na02",
                                "branch",
                                "merge",
                                "repo",
                                "da",
                                "build_009",
                                "build_007",
                                "build_006",
                                "build_005",
                                "created",
                                "add",
                                "table",
                                "master"))

# Tokenise and remove stopwords
commit_messages <- unnest_tokens(commits_cln, word, comment) %>% 
  anti_join(stop_words, by = "word") %>% 
  anti_join(stops_manual, by = "word")

# Count words
word_counts <- count(commit_messages, word)
word_counts_by_author <- count(commit_messages, author, word)
```

## Popular commit words

```{r pop_words, echo = FALSE}
word_counts %>% 
  arrange(desc(n)) %>% 
  slice(1:20) %>% 
  mutate(word = forcats::fct_inorder(word),
         word = forcats::fct_rev(word)) %>% 
  ggplot(aes(word, n)) +
  geom_col(fill = kpmgcolours("graphs")[1]) +
  labs(x = "Word",
       y = "Times used in commit message",
       title = "Total uses of words across all commits") +
  coord_flip() +
  theme_kpmg()
```

## Commit words sentiment

```{r, message_sentiment, echo = FALSE, message = FALSE}
# Pull in sentiments data
word_sentiments <- get_sentiments("nrc")

# Join sentiments to words in commit messages
commits_to_sentiment <- commit_messages %>% 
  left_join(word_sentiments, by = "word")

# Aggregate and plot!
commits_to_sentiment %>% 
  filter(!is.na(sentiment)) %>% 
  mutate(sentiment = forcats::fct_infreq(sentiment),
         sentiment = forcats::fct_rev(sentiment)) %>% 
  ggplot(aes(sentiment)) +
  geom_bar(stat = "count",
           fill = unname(kpmgcolours("graphs")[1])) +
  labs(x = "Sentiment",
       y = "Words with sentiment",
       title = "Total words with associated sentiment",
       subtitle = "Looks like we had a positive experience") +
  coord_flip() +
  theme_kpmg()
```